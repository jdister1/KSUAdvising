@model KSUAdvising.Models.StudentViewModel
@using Newtonsoft.Json
@{
    ViewBag.Title = "Index";
}

@section Scripts{
    <script type="text/javascript">
    //getting the autogenerated hub proxy
    var alertHubProx = $.connection.alertHub;

    //global variable to store student email
    var flashlineID;
    $(document).ready(function () {
        //starts connection
        $.connection.hub.start();

        //click event for queue button
        $("#addToQueueButton").click(function(){
            addToWalkinQueue();
        });
        //deserializes data from the view model object
        flashlineID=@Html.Raw(JsonConvert.SerializeObject(Model.flashlineID));
        var studentName = @Html.Raw(JsonConvert.SerializeObject(Model.studentName));
        var hasAppointment = @Html.Raw(JsonConvert.SerializeObject(Model.hasAppointment));
        var isLate = @Html.Raw(JsonConvert.SerializeObject(Model.isLate));
        var adviserFlashlineID = @Html.Raw(JsonConvert.SerializeObject(Model.adviserFlashlineID));
        var adviserName = @Html.Raw(JsonConvert.SerializeObject(Model.adviserName));

        if(hasAppointment && !isLate)
        {
            //display on time message
            appointmentArrivedOnTime(studentName, flashlineID, adviserName, adviserFlashlineID);
        }
        if(hasAppointment && isLate)
        {
            appointmentArrivedLate();
        }
        if(!hasAppointment){
            $("#no_appointment").show();
        }
            //$.blockUI({
            //    message: "<h1>Thank you, an advisor will be with you shortly.</h1>",
            //    css: { backgroundColor: '#F9B71B'},
            //    timeout: 2000
            //});
    });

    function appointmentArrivedOnTime(studentName, flashlineID, adviserName, adviserFlashlineID){
        $.blockUI({
            message: "Thank you <b>" + studentName + "</b> <br/><br/> <b>"+ adviserName +"</b> will be with you shortly.",
            css: { backgroundColor: '#F9B71B'}
        });
        setTimeout(function() { 
            $.unblockUI({ 
                onUnblock: function(){ 
                    $("#submitAfterAppointment").submit();
                    
                    //send out arrival alert
                    alertHubProx.server.appointmentArrival(flashlineID, adviserFlashlineID);
                } 
            }); 
        }, 4000); 
    }

    function appointmentArrivedLate(studentName, adviserName){
        $.blockUI({
            message: "<h2>Sorry <b>" + studentName + "</b>, you are late for your appointment with " + adviserName,
            css: { backgroundColor: '#F9B71B'},
            timeout: 6000
        });
    }

    function addToWalkinQueue(){

        //send alert via hub
        alertHubProx.server.studentInQueue(flashlineID, " just signed up for a walkin appointment");
        $.blockUI({
            message: "<h2>Thank You.</h2> You've been added to the walk-in queue",
            css: { backgroundColor: '#F9B71B'},
        });
        setTimeout(function() { 
            $.unblockUI({ 
                onUnblock: function(){ 
                    $("#submitAfterQueue").submit();
                } 
            }); 
        }, 4000); 

    }

    </script>
}
<style>
    .studentButton{
        background-color:#009DDB !important;
    }
</style>

<div id="navbar" class="icon-bar one-up">

    <a id="home_button" class="item">
        <span class="login_header">KSU Advising</span>
    </a>
</div>

<div id="no_appointment" style="display:none" class="large-4 large-centered columns">
    <div class="panel">
            <h2>Hi, @Model.flashlineID</h2>
            <p>Click E-mail a Link to recieve an E-mail with a URL to KSU's Advising website to schedule an appointment. This will automatically log you out of the system.
               @if (Model.walkinsAllowed)
               {
                <span>Or, sign up for the next available walk-in appointment.</span>
               }
               else
               {
                <span>There are no more spots available in the walk-in queue today.</span>
               }
            </p>
        <ul class="button-group">
            @if (Model.walkinsAllowed)
            {
                <li><a id="addToQueueButton" class="studentButton button alert">Walk-In</a></li>
            }
            <li><a href="@Url.Action("EmailLink","Login")" class="studentButton button success">E-Mail Link</a></li>
        </ul>
        <br/>
        <a href="@Url.Action("Index","Login")" class="button alert">Logout</a> 
        
    </div>
</div>


<div style="display:none;" id="schedule_appointment" class="large-4 large-centered columns">
        <form>
            <fieldset>
                <legend>Walk-In Sign Up</legend>
                <div class="small-4 columns">
                    <label for="right-label" class="right inline">Banner ID</label>
                </div>
                <div class="small-8 columns">
                    <input type="text" id="right-label" placeholder="xxxxxxxxx">
                    <a href="#" class="button tiny alert">Dont' Know</a>
                </div>
                <textarea placeholder="Breif Description"></textarea>
            </fieldset>
            <a href="#" class="button success">Submit</a>
        </form>
</div>

<form id="submitAfterQueue" action="@Url.Action("AddStudentToQueue", "Login")" style="display:none">
</form>
<form id="submitAfterAppointment" action="@Url.Action("Index","Login")" style="display:none">
</form>
